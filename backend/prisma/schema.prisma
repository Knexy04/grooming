generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())

  activations Activation[]

  @@index([email])
}

model Campaign {
  id        String   @id @default(cuid())
  name      String
  status    String   @default("active")
  note      String?  // примечание при создании/редактировании
  createdAt DateTime @default(now())

  leaflets Leaflet[]
}

model Leaflet {
  id         String   @id @default(cuid())
  campaignId String
  publicCode String   @unique
  printCount Int      @default(1) // сколько одинаковых бумажек напечатано в этой пачке
  status     String   @default("active")
  note       String?
  createdAt  DateTime @default(now())

  campaign    Campaign            @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  assignments LeafletAssignment[]
  activations Activation[]

  @@index([campaignId])
  @@index([publicCode])
}

model Distributor {
  id        String   @id @default(cuid())
  fullName  String
  phone     String
  note      String?
  createdAt DateTime @default(now())

  assignments LeafletAssignment[]

  @@index([phone])
}

model LeafletAssignment {
  id              String   @id @default(cuid())
  leafletId       String
  distributorId   String
  rewardPerClient Int
  note            String?
  assignedAt      DateTime @default(now())
  unassignedAt    DateTime?

  leaflet     Leaflet     @relation(fields: [leafletId], references: [id], onDelete: Cascade)
  distributor Distributor @relation(fields: [distributorId], references: [id], onDelete: Cascade)
  activations Activation[]

  @@index([leafletId, unassignedAt])
  @@index([distributorId])
}

model Activation {
  id            String   @id @default(cuid())
  leafletId     String
  assignmentId  String?
  note          String?
  activatedAt   DateTime @default(now())
  activatedById String

  leaflet    Leaflet            @relation(fields: [leafletId], references: [id], onDelete: Cascade)
  assignment LeafletAssignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  activatedBy User              @relation(fields: [activatedById], references: [id], onDelete: Cascade)

  @@index([leafletId, activatedAt])
  @@index([assignmentId])
}


